# Парсер автозапчастей с сайта partsgeek

## Состав репозитория

- **`parse.py`** — основной парсер. Берёт задачи из очереди в БД, обходит каталог → категории → товары и сохраняет результат.
- **`db.py`** — обёртка над SQLite: создание схемы, очереди, блокировки, upsert-ы и счётчики прогресса.
- **`repair.py`** — утилита обслуживания:
  - удаляет «пустые» товары из `products` (без заголовка/цены/артикула/бренда и с пустыми атрибутами);
  - переводит задачи со статусом `error` в `pending` и снимает «замки», чтобы парсер прошёл их заново.
- **`partsgeek.sqlite3`** — файл базы данных (создаётся автоматически при первом запуске).

## Схема базы данных

### Таблица: `queue`
Очередь задач на обход.
- `url` — **PRIMARY KEY**, уникальный адрес задачи.
- `kind` — `'catalog' | 'category' | 'product'`.
- `status` — `'pending' | 'done' | 'error'`.
- `tries` — кол-во попыток.
- `last_error` — текст последней ошибки (усечён до ~1000 символов).
- `updated_at` — UNIX-время последнего изменения.

Индексы:  
- `idx_queue_status (status)`  
- `idx_queue_kind_status (kind, status)`

### Таблица: `locks`
Советующие «замки» на URL, чтобы несколько воркеров не взяли одну задачу.
- `url` — **PRIMARY KEY**.
- `ts` — UNIX-время постановки замка.

### Таблица: `categories`
Категории каталога (справочник).
- `url` — **PRIMARY KEY**.
- `name` — название категории (как на сайте).
- `discovered_at` — когда была найдена.

### Таблица: `product_discovery`
Факты обнаружения ссылок на карточки при обходе категорий.
- `url` — **PRIMARY KEY** (ссылка на карточку товара).
- `title` — анкор ссылки со страницы категории.
- `category_url` — откуда нашли.
- `discovered_at` — когда нашли.

### Таблица: `products`
Итоговые данные карточек.
- `url` — **PRIMARY KEY** (страница товара).
- `title` — заголовок карточки.
- `price` — цена (число, без валютного символа).
- `currency` — валюта.
- `part_number` — артикул/номер детали.
- `brand` — бренд.
- `stock` — количество в наличии (если указано, например `(3) In Stock`).
- `prod_id`, `app_id`, `alt_sku` — скрытые поля формы с карточки.
- `category_url` — категория, из которой пришли.
- `attrs_json` — **JSON** со всеми атрибутами из блока спецификаций (ключ → значение).
- `fitment_json` — **JSON**-список совместимостей `[{vehicle, sub_model, engine}, …]`.
- `discovered_at` — когда впервые обнаружили (для новых вставок).
- `scraped_at` — когда спарсили/обновили в последний раз.

## Быстрый старт

```bash
# создать и активировать venv
python -m venv .venv && source .venv/bin/activate

pip install -r requirements.txt

# запустить парсер
python parse.py

# очистить ошибки, обновить очередь
python repair.py 
```